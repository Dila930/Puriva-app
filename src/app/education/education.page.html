<ion-content [fullscreen]="true" class="news-content">
  <div class="container">
    <!-- Header Section -->
    <div class="header fade-in-up">
      <div class="page-title">📰 Berita & Update</div>
      <div class="header-subtitle">Informasi terbaru seputar PURIVA</div>
      
      <!-- Search + Filter (categories moved into filter icon) -->
      <div class="search-row">
        <input type="text" 
               class="search-bar" 
               placeholder="🔍 Cari berita..." 
               [(ngModel)]="searchQuery"
               (input)="searchNews($event)">
        <ion-button class="filter-btn" fill="clear" (click)="openFilterSheet()" aria-label="Filter kategori">
          <ion-icon name="options-outline"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Custom Filter Popover - moved outside header to avoid stacking context issues -->
    <div *ngIf="showFilter" class="filter-popover-backdrop" (click)="closeFilter()"></div>
    <div *ngIf="showFilter" class="filter-popover" (click)="$event.stopPropagation()">
      <div class="filter-header">Urutkan Berdasarkan</div>
      <div class="option-list">
        <button class="option" [class.active]="sortMode==='terbaru'" (click)="chooseSort('terbaru')">
          <span class="icon">⬇️</span>
          <span class="label">Terbaru</span>
          <ion-icon class="check" *ngIf="sortMode==='terbaru'" name="checkmark-outline"></ion-icon>
        </button>
        <button class="option" [class.active]="sortMode==='terlama'" (click)="chooseSort('terlama')">
          <span class="icon">⬆️</span>
          <span class="label">Terlama</span>
          <ion-icon class="check" *ngIf="sortMode==='terlama'" name="checkmark-outline"></ion-icon>
        </button>
        <button class="option" [class.active]="sortMode==='az'" (click)="chooseSort('az')">
          <span class="icon">🔡</span>
          <span class="label">A - Z</span>
          <ion-icon class="check" *ngIf="sortMode==='az'" name="checkmark-outline"></ion-icon>
        </button>
        <button class="option" [class.active]="sortMode==='za'" (click)="chooseSort('za')">
          <span class="icon">🔠</span>
          <span class="label">Z - A</span>
          <ion-icon class="check" *ngIf="sortMode==='za'" name="checkmark-outline"></ion-icon>
        </button>
      </div>
      <div class="divider"></div>
      <div class="filter-header">Filter Kategori</div>
      <div class="option-list">
        <button class="option" [class.active]="currentFilter==='semua'" (click)="chooseCategory('semua')">
          <span class="icon">🌟</span>
          <span class="label">Semua</span>
          <ion-icon class="check" *ngIf="currentFilter==='semua'" name="checkmark-outline"></ion-icon>
        </button>
        <button class="option" [class.active]="currentFilter==='teknologi'" (click)="chooseCategory('teknologi')">
          <span class="icon">💻</span>
          <span class="label">Teknologi</span>
          <ion-icon class="check" *ngIf="currentFilter==='teknologi'" name="checkmark-outline"></ion-icon>
        </button>
        <button class="option" [class.active]="currentFilter==='kesehatan'" (click)="chooseCategory('kesehatan')">
          <span class="icon">🩺</span>
          <span class="label">Kesehatan</span>
          <ion-icon class="check" *ngIf="currentFilter==='kesehatan'" name="checkmark-outline"></ion-icon>
        </button>
        <button class="option" [class.active]="currentFilter==='panduan'" (click)="chooseCategory('panduan')">
          <span class="icon">📘</span>
          <span class="label">Panduan</span>
          <ion-icon class="check" *ngIf="currentFilter==='panduan'" name="checkmark-outline"></ion-icon>
        </button>
      </div>
      <ion-button expand="block" class="close-btn" (click)="closeFilter()">Tutup</ion-button>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Selection mode bar -->
      <div *ngIf="selectionMode" style="position: sticky; top: 0; z-index: 10; background: var(--ion-color-light); padding: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div>{{ selectedIds.size }} dipilih</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <ion-button *ngIf="isAdmin && selectedIds.size > 0" size="small" color="danger" fill="solid" (click)="confirmDeleteSelected()">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Hapus ({{ selectedIds.size }})
          </ion-button>
          <ion-button size="small" fill="outline" (click)="exitSelectionMode()">Selesai</ion-button>
        </div>
      </div>
      <!-- Featured News -->
      <div class="featured-news slide-in-card" (click)="openNewsDetail(featuredNews)">
        <div class="featured-image" style="position:relative; overflow:hidden;">
          <img *ngIf="featuredNews?.thumbnail" [src]="featuredNews.thumbnail" alt="thumbnail"
               style="width:100%; height:100%; object-fit:cover; display:block;"/>
          <div *ngIf="!featuredNews?.thumbnail" style="font-size:48px; line-height:1; display:flex; align-items:center; justify-content:center; width:100%; height:100%;">🔬</div>
          <div class="featured-badge">{{ featuredNews.categoryLabel }}</div>
          <div *ngIf="featuredNews?.isNew" class="new-badge">NEW</div>
        </div>
        <div class="featured-content">
          <div class="featured-title">{{ featuredNews.title }}</div>
          <div class="featured-excerpt">{{ featuredNews.description }}</div>
          <div class="featured-meta">
            <span>📅 {{ featuredNews.date }}</span>
            <div class="read-more">Baca Selengkapnya</div>
          </div>
        </div>
      </div>
      
      <!-- News List -->
      <div class="news-list">
        <div class="news-item slide-in-card" 
             *ngFor="let news of filteredNews; let i = index" 
             [attr.data-category]="news.category"
             (click)="openNewsDetail(news)"
             [style.animation-delay]="(0.3 + i * 0.1) + 's'"
             [style.position]="'relative'">

          <!-- Selection overlay -->
          <div *ngIf="selectionMode" (click)="toggleSelect($event, news.id)" style="position: absolute; top: 8px; left: 8px; z-index: 5;">
            <ion-icon [name]="selectedIds.has(news.id) ? 'checkmark-circle' : 'ellipse-outline'" [style.font-size.px]="22"></ion-icon>
          </div>
          <!-- Admin more button -->
          <div *ngIf="isAdmin && !selectionMode" (click)="openItemActions($event, news)" style="position: absolute; top: 6px; right: 6px; z-index: 5;">
            <ion-button size="small" fill="clear" color="medium">
              <ion-icon name="ellipsis-vertical"></ion-icon>
            </ion-button>
          </div>
          <div class="news-thumbnail" [ngClass]="news.category" style="position:relative; overflow:hidden;">
            <img *ngIf="news?.thumbnail" [src]="news.thumbnail" alt="thumbnail"
                 style="width:100%; height:100%; object-fit:cover; display:block;"/>
            <div *ngIf="!news?.thumbnail" style="font-size:28px; line-height:1; display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
              {{ news.icon }}
            </div>
            <div class="category-label">{{ news.categoryLabel }}</div>
            <div *ngIf="news?.isNew" class="new-badge">NEW</div>
          </div>
          <div class="news-content">
            <div class="news-title">{{ news.title }}</div>
            <div class="news-excerpt">{{ news.description }}</div>
            <div class="news-meta">
              <div class="news-date">📅 {{ news.date }}</div>
              <div class="read-time">⏱️ {{ news.readTime }} menit baca</div>
            </div>
            <!-- Reactions -->
            <div class="news-reactions" style="display:flex; gap:12px; margin-top:8px;">
              <ion-button fill="clear" size="small" (click)="onNewsReact($event, news.id, 'like')">
                <ion-icon [name]="getMyNewsReaction(news.id) === 'like' ? 'thumbs-up' : 'thumbs-up-outline'" slot="start"></ion-icon>
                {{ getNewsCounts(news.id).likes }}
              </ion-button>
              <ion-button fill="clear" size="small" color="medium" (click)="onNewsReact($event, news.id, 'dislike')">
                <ion-icon [name]="getMyNewsReaction(news.id) === 'dislike' ? 'thumbs-down' : 'thumbs-down-outline'" slot="start"></ion-icon>
                {{ getNewsCounts(news.id).dislikes }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Load More Button -->
      <div class="load-more" (click)="loadMoreNews()" *ngIf="showLoadMore">
        📄 {{ loadingMore ? '⏳ Memuat...' : 'Muat Berita Lainnya' }}
      </div>
    </div>
  </div>
</ion-content>

<!-- FAB: Create News (admin only) -->
<ion-fab class="fab-above-bottom-nav" vertical="bottom" horizontal="end" *ngIf="isAdmin">
  <ion-fab-button color="primary" closeIcon="add" (click)="goToCreateNews()" aria-label="Tambah Berita">
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
  <ion-fab-list side="top"></ion-fab-list>
  <ion-fab-list side="start"></ion-fab-list>
</ion-fab>

<app-bottom-nav [activeTab]="'news'"></app-bottom-nav>
