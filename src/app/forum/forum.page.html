<ion-content>
  <div class="forum-container">
    <div class="header">
      <div class="page-title">Forum PURIVA</div>
      <div class="header-subtitle">Berbagi pengalaman dan berdiskusi</div>
      <div class="forum-stats">
        <div class="stat-pill">
          <span class="dot online"></span>
          <span class="count">{{ formatCount(forumStats.activeUsers) }}</span>
          <span>Pengguna Aktif</span>
        </div>
        <div class="stat-pill">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <span class="count">{{ formatCount(forumStats.totalThreads) }}</span>
          <span>Thread</span>
        </div>
        <div class="stat-pill">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          <span class="count">{{ formatCount(forumStats.totalComments) }}</span>
          <span>Komentar</span>
        </div>
      </div>
      <ion-searchbar class="search-bar" placeholder="Cari diskusi" (ionInput)="searchThreads($event)"></ion-searchbar>
    </div>

    <ng-container *ngIf="!showThreadDetail; else detailView">
      <div class="action-section">
        <ion-button expand="block" class="create-thread-btn" (click)="openCreateThreadModal()">
          <ion-icon slot="start" name="add-circle-outline"></ion-icon>
          Buat Thread Baru
        </ion-button>
      </div>

      <div class="categories-section">
        <div class="section-title">Kategori</div>
        <div class="categories-grid">
          <div class="category-item" *ngFor="let c of categories" [class.active]="currentCategory === c.key" (click)="filterByCategory(c.key)">
            <span class="category-icon">{{ c.icon }}</span>
            <span class="category-name">{{ c.name }}</span>
            <span class="category-count">{{ c.count }}</span>
          </div>
        </div>
      </div>

      <div class="threads-section">
        <div *ngIf="filteredThreads.length === 0" class="empty-state">
          <div class="empty-message">Belum ada diskusi.</div>
          <div class="empty-submessage">Mulai diskusi baru untuk berbagi dengan yang lain.</div>
        </div>
        <div class="thread-list">
          <div class="thread-item" *ngFor="let t of filteredThreads" (click)="openThread(t)">
            <div class="thread-header">
              <div class="thread-status">
                <ion-chip size="small" [color]="t.status === 'solved' ? 'success' : 'primary'">{{ t.status === 'solved' ? 'Selesai' : 'Aktif' }}</ion-chip>
              </div>
            </div>
            <div class="thread-title">{{ t.title }}</div>
            <div class="thread-excerpt">{{ getThreadExcerpt(t.content) }}</div>
            <div class="thread-meta">
              <div class="thread-author" style="display:flex; align-items:center; gap:8px;">
                <!-- Avatar -->
                <div class="avatar" style="width:28px; height:28px; border-radius:50%; background:#e5e7eb; color:#374151; display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto;">
                  <img *ngIf="shouldShowAvatar(t.authorUid)" [src]="getAvatarUrl(t.authorUid)" alt="avatar" style="width:100%; height:100%; object-fit:cover;"/>
                  <span *ngIf="!shouldShowAvatar(t.authorUid)" style="font-size:12px; font-weight:700;">{{ getInitials(t.author) }}</span>
                </div>
                <span>{{ t.author }}</span>
                <span class="author-role" [ngClass]="t.role">{{ getRoleText(t.role) }}</span>
              </div>
              <div class="thread-stats">
                <div class="stat-item">
                  <ion-icon name="heart-outline"></ion-icon>
                  <span>{{ getThreadCounts(t.id).likes }}</span>
                </div>
                <div class="stat-item">
                  <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
                  <span>{{ t.comments.length }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #detailView>
      <div class="thread-detail" *ngIf="selectedThread">
        <ion-button fill="clear" size="small" (click)="backToForum()">
          <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
          Kembali
        </ion-button>

        <div class="thread-detail-header">
          <div class="thread-detail-title">{{ selectedThread.title }}</div>
          <div class="thread-author" style="display:flex; align-items:center; gap:8px;">
            <div class="avatar" style="width:32px; height:32px; border-radius:50%; background:#e5e7eb; color:#374151; display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto;">
              <img *ngIf="shouldShowAvatar(selectedThread.authorUid)" [src]="getAvatarUrl(selectedThread.authorUid)" alt="avatar" style="width:100%; height:100%; object-fit:cover;"/>
              <span *ngIf="!shouldShowAvatar(selectedThread.authorUid)" style="font-size:12px; font-weight:700;">{{ getInitials(selectedThread.author) }}</span>
            </div>
            <span>{{ selectedThread.author }}</span>
            <span class="author-role" [ngClass]="selectedThread.role">{{ getRoleText(selectedThread.role) }}</span>
          </div>
        </div>

        <div class="thread-detail-content">{{ selectedThread.content }}</div>

        <div class="thread-actions">
          <ion-button class="action-btn" [class.liked]="isThreadLiked(selectedThread.id)" (click)="onThreadReact(selectedThread.id, 'like')">
            <ion-icon name="thumbs-up-outline"></ion-icon>
            Suka {{ getThreadCounts(selectedThread.id).likes }}
          </ion-button>
          <ion-button class="action-btn" *ngIf="canManageThread(selectedThread)" (click)="openLikersModal(selectedThread.id)">
            <ion-icon name="people-outline"></ion-icon>
            Lihat yang menyukai
          </ion-button>
          <ion-button class="action-btn admin-btn" *ngIf="canManageThread(selectedThread)" (click)="editThreadTitleContent(selectedThread.id)">Edit</ion-button>
          <ion-button class="action-btn admin-btn" *ngIf="canManageThread(selectedThread)" (click)="deleteThread(selectedThread.id)">Hapus</ion-button>
        </div>

        <div class="comments-section">
          <div class="section-title">Komentar</div>
          <div *ngIf="selectedThread.comments.length === 0" class="no-comments">Belum ada komentar.</div>
          <div class="comment-item" *ngFor="let c of selectedThread.comments" [class.my-comment]="isMyComment(selectedThread.id, c)">
            <div class="comment-author" style="display:flex; align-items:center; gap:8px;">
              <div class="avatar" style="width:24px; height:24px; border-radius:50%; background:#e5e7eb; color:#374151; display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto;">
                <img *ngIf="shouldShowAvatar(c.authorUid)" [src]="getAvatarUrl(c.authorUid)" alt="avatar" style="width:100%; height:100%; object-fit:cover;"/>
                <span *ngIf="!shouldShowAvatar(c.authorUid)" style="font-size:10px; font-weight:700;">{{ getInitials(c.author) }}</span>
              </div>
              <span>{{ c.author }}</span>
              <span class="comment-time">{{ getTimeAgo(c.timestamp) }}</span>
            </div>
            <div class="comment-content">{{ c.content }}</div>
            <div class="comment-footer">
              <div class="comment-actions">
                <ion-button fill="clear" size="small" class="comment-like-btn" [class.liked]="isCommentLiked(selectedThread.id, c.id!)" (click)="onCommentReact(selectedThread.id, c.id!)">
                  <ion-icon name="heart-outline"></ion-icon>
                  <span>{{ getCommentLikes(selectedThread.id, c.id!) }}</span>
                </ion-button>
                <ion-button fill="clear" size="small" *ngIf="canViewCommentLikers(selectedThread.id, c)" (click)="openCommentLikers(selectedThread.id, c.id!)">Lihat yang menyukai</ion-button>
                <ion-button fill="clear" size="small" *ngIf="isMyComment(selectedThread.id, c)" (click)="editComment(selectedThread.id, c.id!, c.content)">Edit</ion-button>
                <ion-button fill="clear" size="small" *ngIf="isMyComment(selectedThread.id, c)" (click)="deleteComment(selectedThread.id, c.id!)">Hapus</ion-button>
              </div>
            </div>
          </div>
        </div>

        <div class="reply-form">
          <ion-textarea class="reply-input" [(ngModel)]="newComment" placeholder="Tulis balasan..."></ion-textarea>
          <ion-button class="reply-submit" (click)="submitReply()" [disabled]="isPostingComment || !newComment">
            Kirim
          </ion-button>
        </div>
      </div>
    </ng-template>

    <!-- Modal: Create Thread -->
    <ion-modal [isOpen]="showCreateThreadModal" (didDismiss)="showCreateThreadModal = false" class="create-thread-content">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Buat Thread Baru</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="showCreateThreadModal = false">Tutup</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <div class="create-thread-form">
            <ion-item>
              <ion-label position="stacked">Judul</ion-label>
              <ion-input name="title" [(ngModel)]="newThreadForm.title" placeholder="Masukkan judul thread"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Kategori</ion-label>
              <ion-select name="category" interface="popover" [(ngModel)]="newThreadForm.category" placeholder="Pilih kategori">
                <ion-select-option *ngFor="let c of categories" [value]="c.key" [disabled]="c.key === 'all'">{{ c.name }}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item lines="none">
              <ion-label position="stacked">Konten</ion-label>
              <ion-textarea name="content" autoGrow="true" [(ngModel)]="newThreadForm.content" placeholder="Tulis isi thread"></ion-textarea>
            </ion-item>

            <div style="height: 12px"></div>
            <ion-button expand="block" (click)="createNewThread()" [disabled]="isPostingThread || !newThreadForm.title || !newThreadForm.category || !newThreadForm.content">
              Simpan Thread
            </ion-button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>
    <!-- Modal: Likers -->
    <ion-modal [isOpen]="showLikersModal" (didDismiss)="closeLikersModal()" class="likers-modal">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Yang Menyukai</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeLikersModal()">Tutup</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <div class="likers-list" style="padding: 12px;">
            <div *ngIf="likersForThreadId as tid; else commentLikersTpl">
              <div class="section-title">Disukai oleh</div>
              <div *ngIf="(threadLikers[tid]?.length || 0) === 0" class="empty-state">Belum ada yang menyukai.</div>
              <ion-list *ngIf="(threadLikers[tid]?.length || 0) > 0">
                <ion-item *ngFor="let name of threadLikers[tid]">
                  <ion-label>{{ name }}</ion-label>
                </ion-item>
              </ion-list>
            </div>
            <ng-template #commentLikersTpl>
              <div *ngIf="likersForComment as lc">
                <div class="section-title">Disukai oleh</div>
                <div *ngIf="(commentLikers[lc.threadId]?.[lc.commentId]?.length || 0) === 0" class="empty-state">Belum ada yang menyukai.</div>
                <ion-list *ngIf="(commentLikers[lc.threadId]?.[lc.commentId]?.length || 0) > 0">
                  <ion-item *ngFor="let name of commentLikers[lc.threadId][lc.commentId]">
                    <ion-label>{{ name }}</ion-label>
                  </ion-item>
                </ion-list>
              </div>
            </ng-template>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>
    <app-bottom-nav [activeTab]="'forum'"></app-bottom-nav>
  </div>
</ion-content>