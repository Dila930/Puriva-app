<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/profile"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
  </ion-header>

<ion-content class="profile-detail" [fullscreen]="true">
  <div class="header">
    <h1>Pengaturan Akun</h1>
    <p>Ubah informasi pribadi dan preferensi Anda.</p>
  </div>
  <div class="content" [class.fade-in]="isPageReady">
    <ion-list lines="none">
      <!-- Profile Photo Upload -->
      <ion-item class="card" detail="false">
        <ion-label>
          <div style="display:flex; align-items:center; gap:12px;">
            <div style="width:56px; height:56px; border-radius:50%; background:#eef2ff; color:#374151; display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto;">
              <img *ngIf="photoPreviewUrl" [src]="photoPreviewUrl" alt="Foto Profil" style="width:100%; height:100%; object-fit:cover;"/>
              <span *ngIf="!photoPreviewUrl" style="font-weight:700;">{{ displayInitial }}</span>
            </div>
            <div>
              <div style="font-weight:600;">Foto Profil</div>
              <div style="font-size:12px; color:#6b7280;">PNG/JPG sampai 2MB</div>
              <div *ngIf="isUploadingPhoto" style="font-size:12px; color:#2563eb; margin-top:4px;">Mengunggah... {{ photoUploadProgress }}%</div>
            </div>
          </div>
        </ion-label>
        <input #photoInput type="file" accept="image/*" (change)="onPhotoSelected($event)" [disabled]="isUploadingPhoto" hidden />
        <ion-button slot="end" size="small" [disabled]="isUploadingPhoto" (click)="photoInput.click()">
          {{ isUploadingPhoto ? 'Mengunggah...' : 'Ubah Foto' }}
        </ion-button>
      </ion-item>

      <ion-item class="card" detail="false">
        <ion-label>Ubah Nama Tampilan</ion-label>
        <ion-button slot="end" size="small" (click)="changeDisplayName()">Ubah</ion-button>
      </ion-item>
      
      <!-- Tambah/Info Password (khusus user Google) -->
      <ng-container *ngIf="isGoogleUser">
        <ion-item class="card" detail="false">
          <ion-label>
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-weight:600;">Kata Sandi Akun</div>
              <div *ngIf="hasPassword; else addPwBlock" style="font-size:14px; color:#374151;">
                Password saya: <span style="font-family:monospace;">{{ maskedPassword }}</span>
              </div>
              <ng-template #addPwBlock>
                <div style="font-size:13px; color:#6b7280;">Anda login dengan Google dan belum menambahkan password. Tambahkan password agar bisa login dengan email & password juga.</div>
                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                  <ion-input [type]="'password'" placeholder="Minimal 6 karakter" [(ngModel)]="newPassword" [disabled]="isSavingPassword"></ion-input>
                  <ion-button size="small" [disabled]="isSavingPassword || (newPassword?.length||0) < 6" (click)="addPassword()">
                    {{ isSavingPassword ? 'Menyimpan...' : 'Tambah' }}
                  </ion-button>
                </div>
              </ng-template>
            </div>
          </ion-label>
        </ion-item>
      </ng-container>
      
      <ion-item class="card" detail="false" [class.loading]="isSaving">
        <ion-label>Preferensi Notifikasi</ion-label>
        <ion-spinner slot="end" name="crescent" *ngIf="isSaving"></ion-spinner>
        <ion-toggle slot="end" [(ngModel)]="notifEmail" (ionChange)="onNotifEmailChange($event)" [disabled]="isSaving">Email</ion-toggle>
      </ion-item>
      <ion-item class="card" detail="false">
        <ion-label>Privasi Akun</ion-label>
        <ion-button slot="end" size="small" (click)="openPrivacy()">Kelola</ion-button>
      </ion-item>
      <ion-item class="card" detail="false">
        <ion-label>Refresh Aplikasi</ion-label>
        <ion-button slot="end" color="primary" size="small" (click)="refreshApp()">Refresh</ion-button>
      </ion-item>
    </ion-list>
  </div>

  <!-- Privacy Modal -->
  <div class="privacy-modal-overlay" *ngIf="isPrivacyOpen" style="position:fixed; inset:0; background:rgba(0,0,0,0.32); z-index:1000; display:flex; align-items:center; justify-content:center; padding:16px;">
    <div class="privacy-modal" style="background:#fff; width:100%; max-width:520px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.12); overflow:hidden;">
      <div style="padding:16px 20px; border-bottom:1px solid #eef1f5; display:flex; align-items:center; justify-content:space-between;">
        <h2 style="margin:0; font-size:18px; font-weight:700; color:#111827;">Pengaturan Privasi</h2>
        <ion-button fill="clear" size="small" (click)="closePrivacy()">Tutup</ion-button>
      </div>
      <div style="padding:16px 20px; display:flex; flex-direction:column; gap:12px;">
        <ion-item lines="full">
          <ion-label>Visibilitas Profil</ion-label>
          <ion-select interface="popover" [(ngModel)]="privacy.profileVisibility">
            <ion-select-option value="public">Publik</ion-select-option>
            <ion-select-option value="private">Privat</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item lines="full">
          <ion-label>Tampilkan Email</ion-label>
          <ion-toggle slot="end" [(ngModel)]="privacy.showEmail"></ion-toggle>
        </ion-item>
        <ion-item lines="full">
          <ion-label>Bagikan Data Penggunaan (untuk peningkatan fitur)</ion-label>
          <ion-toggle slot="end" [(ngModel)]="privacy.shareUsage"></ion-toggle>
        </ion-item>
        <ion-item lines="full">
          <ion-label>Visibilitas Aktivitas</ion-label>
          <ion-select interface="popover" [(ngModel)]="privacy.activityVisibility">
            <ion-select-option value="everyone">Semua Orang</ion-select-option>
            <ion-select-option value="friends">Hanya Teman</ion-select-option>
            <ion-select-option value="only_me">Hanya Saya</ion-select-option>
          </ion-select>
        </ion-item>
        <div style="display:flex; gap:8px; justify-content:space-between; margin-top:6px;">
          <ion-button fill="outline" color="medium" (click)="exportMyData()">
            Ekspor Data (JSON)
          </ion-button>
          <div style="display:flex; gap:8px;">
            <ion-button fill="outline" (click)="closePrivacy()">Batal</ion-button>
            <ion-button [disabled]="isSaving" (click)="savePrivacy()">Simpan</ion-button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
