<ion-header [translucent]="true">
    <ion-toolbar class="dashboard-toolbar">
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/home"></ion-back-button>
      </ion-buttons>
      <ion-title class="dashboard-title">
        <div class="title-content">
          <ion-icon name="analytics-outline" class="title-icon"></ion-icon>
          <span class="gradient-text">Statistik Dashboard</span>
        </div>
      </ion-title>
      <ion-buttons slot="end">
        <ion-button fill="clear" class="refresh-btn" (click)="refreshData()">
          <ion-icon name="refresh-outline" [class.spinning]="isRefreshing"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  
  <ion-content [fullscreen]="true" class="statistics-dashboard">
    <!-- Background Elements -->
    <div class="parallax-element element-1"></div>
    <div class="parallax-element element-2"></div>
    <div class="parallax-element element-3"></div>
    
    <!-- Real-time Indicator -->
    <div class="realtime-indicator fade-in-up" [class.visible]="isLoaded">
      <div class="status-dot"></div>
      <span>Real-time Data</span>
    </div>
  
    <div class="container">
      <!-- Header Section -->
      <div class="dashboard-header fade-in-up" [class.visible]="isLoaded">
        <h1>Manajemen Statistik</h1>
        <p class="subtitle">Dashboard Analitik & Monitoring Real-time</p>
      </div>
  
      <!-- Period Selector -->
      <div class="period-selector fade-in-up" [class.visible]="isLoaded">
        <ion-segment 
          [(ngModel)]="selectedPeriod" 
          class="period-segment"
          (ionChange)="onPeriodChange($event)">
          <ion-segment-button value="daily" class="period-btn">
            <ion-icon name="today-outline"></ion-icon>
            <ion-label>Harian</ion-label>
          </ion-segment-button>
          <ion-segment-button value="weekly" class="period-btn">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>Mingguan</ion-label>
          </ion-segment-button>
          <ion-segment-button value="monthly" class="period-btn">
            <ion-icon name="calendar-number-outline"></ion-icon>
            <ion-label>Bulanan</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>
  
      <!-- Loading state -->
      <div *ngIf="isLoading" class="loading ion-padding">
        <div class="spinner"></div>
        <div class="loading-text">Memuat data statistik...</div>
      </div>
  
      <!-- Stats Grid -->
      <div *ngIf="!isLoading" class="stats-grid fade-in-up" [class.visible]="isLoaded">
        <!-- Total Card -->
        <ion-card class="stat-card interactive-element" [class.state-indicator]="true">
          <ion-card-content>
            <div class="stat-inline">
              <div class="stat-icon total">
                <ion-icon name="bar-chart-outline"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value" [class.skeleton]="isLoading">
                  {{ isLoading ? '' : (statsTotals.total | number) }}
                </div>
                <div class="stat-label">Total Transaksi</div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
  
        <!-- Berhasil Card -->
        <ion-card class="stat-card interactive-element success">
          <ion-card-content>
            <div class="stat-inline">
              <div class="stat-icon success">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value" [class.skeleton]="isLoading">
                  {{ isLoading ? '' : (statsTotals.berhasil | number) }}
                </div>
                <div class="stat-label">Berhasil</div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
  
        <!-- Gagal Card -->
        <ion-card class="stat-card interactive-element error">
          <ion-card-content>
            <div class="stat-inline">
              <div class="stat-icon failed">
                <ion-icon name="close-circle-outline"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value" [class.skeleton]="isLoading">
                  {{ isLoading ? '' : (statsTotals.gagal | number) }}
                </div>
                <div class="stat-label">Gagal</div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
  
        <!-- Efektivitas Card -->
        <ion-card class="stat-card interactive-element">
          <ion-card-content>
            <div class="stat-inline">
              <div class="stat-icon effectiveness">
                <ion-icon name="speedometer-outline"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value" [class.skeleton]="isLoading">
                  {{ isLoading ? '' : getEffectiveness() }}%
                </div>
                <div class="stat-label">Efektivitas</div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
  
      
  
      <!-- Detailed Table -->
      <ion-card class="detailed-table fade-in-up" [class.visible]="isLoaded">
        <div class="table-header">
          <h3>Detail Statistik</h3>
        </div>
        <ion-card-content class="table-content">
          <div class="table-wrapper" *ngIf="!isLoading; else tableLoading">
            <table>
              <thead>
                <tr>
                  <th (click)="sortBy('label')" class="sortable">
                    <span>Kategori</span>
                    <ion-icon 
                      name="chevron-up-outline" 
                      *ngIf="sortField === 'label' && sortDirection === 'asc'">
                    </ion-icon>
                    <ion-icon 
                      name="chevron-down-outline" 
                      *ngIf="sortField === 'label' && sortDirection === 'desc'">
                    </ion-icon>
                  </th>
                  <th (click)="sortBy('value')" class="sortable">
                    <span>Nilai</span>
                    <ion-icon 
                      name="chevron-up-outline" 
                      *ngIf="sortField === 'value' && sortDirection === 'asc'">
                    </ion-icon>
                    <ion-icon 
                      name="chevron-down-outline" 
                      *ngIf="sortField === 'value' && sortDirection === 'desc'">
                    </ion-icon>
                  </th>
                  <th>Persentase</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of getSortedDetailData(); trackBy: trackByFn" 
                    class="data-row"
                    (click)="openDetailModal(row)">
                  <td>{{ row.label }}</td>
                  <td class="value">{{ row.value | number }}</td>
                  <td>
                    <div class="percentage-bar">
                      <div class="percentage-fill" 
                           [style.width.%]="getPercentage(row.value)"
                           [class]="getStatusClass(row.status)"></div>
                      <span class="percentage-text">{{ getPercentage(row.value) }}%</span>
                    </div>
                  </td>
                  <td>
                    <ion-chip 
                      [color]="getChipColor(row.status)" 
                      class="status-chip">
                      <ion-icon [name]="getStatusIcon(row.status)"></ion-icon>
                      <ion-label>{{ row.status }}</ion-label>
                    </ion-chip>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <ng-template #tableLoading>
            <div class="table-skeleton">
              <div class="skeleton-row" *ngFor="let item of [1,2,3,4,5]">
                <div class="skeleton skeleton-cell"></div>
                <div class="skeleton skeleton-cell"></div>
                <div class="skeleton skeleton-cell"></div>
                <div class="skeleton skeleton-cell"></div>
              </div>
            </div>
          </ng-template>
        </ion-card-content>
      </ion-card>
  
      
    </div>
  
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isInitialLoading">
      <div class="loading-content">
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Memuat Dashboard...</div>
        </div>
      </div>
    </div>
  </ion-content>
  
  <!-- Toast Container -->
  <ion-toast 
    [isOpen]="showToast" 
    [message]="toastMessage" 
    [duration]="3000"
    [color]="toastColor"
    (didDismiss)="showToast = false">
  </ion-toast>
  
  
  
  <!-- Modal for Detail View -->
  <ion-modal [isOpen]="showDetailModal" (didDismiss)="closeDetailModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Detail Statistik</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeDetailModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <div class="detail-content" *ngIf="selectedDetailItem">
          <div class="detail-header">
            <h2>{{ selectedDetailItem.label }}</h2>
            <ion-chip [color]="getChipColor(selectedDetailItem.status)">
              {{ selectedDetailItem.status }}
            </ion-chip>
          </div>
          
          <div class="detail-stats">
            <div class="detail-stat">
              <span class="label">Nilai:</span>
              <span class="value">{{ selectedDetailItem.value | number }}</span>
            </div>
            <div class="detail-stat">
              <span class="label">Persentase:</span>
              <span class="value">{{ getPercentage(selectedDetailItem.value) }}%</span>
            </div>
            <div class="detail-stat">
              <span class="label">Trend:</span>
              <span class="value" [class]="selectedDetailItem.trend > 0 ? 'positive' : 'negative'">
                {{ selectedDetailItem.trend > 0 ? '+' : '' }}{{ selectedDetailItem.trend }}%
              </span>
            </div>
          </div>
          
          <div class="detail-chart">
            <canvas #detailChart></canvas>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>